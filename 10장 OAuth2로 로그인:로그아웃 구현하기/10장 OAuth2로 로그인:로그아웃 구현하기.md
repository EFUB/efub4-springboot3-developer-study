# 스프링부트3

# 10장 OAuth2로 로그인/로그아웃 구현하기

## 10.1 사전 지식: OAuth

- 10.1.1 OAuth란?
    - 제3의 서비스에 계정 관리를 맡기는 방식
    - 네이버 로그인, 구글 로그인과 같은 방법
    - 관련 용어 정리
        - resource owner : 자신의 정보를 사용하도록 인증 서버에 허가하는 주체, 서비스를 이용하는 사용자가 리소스 오너에 해당
        - resource server : 리소스 오너의 정보를 가지며, 리소스 오너의 정보를 보호하는 주체
            - 네이버, 구글, 페이스북 등이 리소스 서버에 해당
        - authorization server : 클라이언트에게 리소스 오너의 정보에 접근할 수 있는 토큰을 발급하는 역할을 하는 애플리케이션
        - client application : 인증 서버에게 인증을 받고 리소스 오너의 리소스를 사용하는 주체
            - 지금 만들고 있는 서비스가 여기에 해당됨
    - OAuth를 사용하면 인증 서버에서 발급받은 토큰을 사용해 리소스 서버에 리소스 오너의 정보를 요청하고 응답받아 사용할 수 있음
    - 리소스 오너의 정보를 취득하는 4가지 방법
        - **권한 부여 코드 승인 타입** : 가장 잘 알려진 인증 방법, 클라이언트가 리소스에 접근하는 데 사용하며 권한에 접근할 수 있는 코드와 리소스 오너에 대한 액세스 토큰을 발급받는 방식
        - 암시적 승인 타입 : 서버가 없는 자바스크립트 웹 어플리케이션 클라이언트에서 주로 사용하는 방법, 클라이언트가 요청을 보내면 리소스 오너의 인증 과정 이외에는 권한 코드 교환 등의 별다른 인증 과정을 거치지 않고 액세스 토큰을 제공받는 방식
        - 리소스 소유자 암호 자격증명 승인 타입 : 클라이언트의 패스워드를 이용해서 액세스 토큰에 대한 사용자의 자격 증명을 교환하는 방식
        - 클라이언트 자격증명 승인 타입 : 클라이언트가 컨텍스트 외부에서 액세스 토큰을 얻어 특정 리소스에 접근을 요청할 때 사용하는 방식
- 10.1.2 권한 부여 코드 승인 타입이란?
    
    ![스크린샷 2024-05-14 오후 3.02.05.png](%E1%84%89%E1%85%B3%E1%84%91%E1%85%B3%E1%84%85%E1%85%B5%E1%86%BC%E1%84%87%E1%85%AE%E1%84%90%E1%85%B33%203837afd158ed4ea385a25b5a8a2cb3f0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-05-14_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_3.02.05.png)
    
    - 권한 요청이란?
        - 클라이언트(스프링 부트 서버)가 특정 사용자 데이터에 접근하기 위한 권한 서버(카카오나 구글 권한 서버)에 요청을 보내는 것
        - 요청 URI는 권한 서버마다 다름
            - 보통 클라이언트 ID, 리다이렉트 URI, 응답 타입 등을 파라미터로 보냄
                - 예)
                    
                    ```java
                    GET spring-authorization-server.example/authorize?
                    	client_id=66a36b4c2& 
                    	redirect_uri=http://localhost:8080/myapp& 
                    	response_type=code& 
                    	scope=profile 
                    ```
                    
                    - client_id : 인증 서버가 클라이언트에 할당한 고유 식별자로 클라이언트 애플리케이션을 OAuth 서비스에 등록할 때 서비스에서 생성하는 값
                    - redirect_uri : 로그인 성공 시 이동해야 하는 URI
                    - response_type : 클라이언트가 제공받길 원하는 응답 타입, 인증 코드를 받을 때는 code값을 포함해야 함
                    - scope : 제공받고자 하는 리소스 오너의 정보 목록
    - 데이터 접근용 권한 부여
        - 인증 서버에 요청을 처음 보내는 경우 사용자에게 보이는 페이지를 로그인 페이지로 변경, 사용자의 데이터에 접근 동의를 얻음
            - 최초 1회만 진행되고 이후에는 인증 서버에서 동의 내용 저장 → 로그인만 진행
        - 로그인 성공 → 권한 부여 서버 : 인증 및 권한 부여 수신
    - 인증 코드 제공
        - 사용자가 로그인에 성공하면 권한 요청 시 파라미터로 보낸 redirect_uri로 리다이렉션됨
        - 이때 파라미터에 인증 코드를 함께 제공함
        - 인증 코드 예시
            
            ```java
            GET http://localhost:8080/myapp?code=a1s2f3mcj2
            ```
            
    - 액세스 토큰 응답이란?
        - 인증 코드를 받으면 액세스 토큰으로 교환해야 함
        - 액세스 토큰
            - 로그인 세션에 대한 보안 자격을 증명하는 식별 코드
            - 보통 /token POST 요청을 보냄
                
                ```java
                POST spring-authorization-server.example.com/token
                {
                	"client_id": "66a36b4c2",
                	"client_secret": "aabb11dd44", //OAuth 서비스에 등록할 때 제공받는 비밀키
                	"redirect_uri": "http://localhost:8080/myapp",
                	"grant_type": "authorization_code", //권한 유형 확인에 사용, 권한 서버는 유효한 정보라면 액세스 토큰을 응답함
                	"code": "a1b2c3d4e5f6g7h8"
                }
                ```
                
    - 액세스 토큰으로 API 응답 & 반환
        - 액세스 토큰으로 리소스 오너 정보를 가져올 수 있음
        - 정보가 필요할 때마다 API 호출을 통해 정보를 가져옴
            - 예
                
                ```java
                GET spring-authorization-resouce-server.example.com/userinfo
                Header: Authorization: Bearer aasdffb
                ```
                
        - 리소스 서버는 토큰이 유효한지 검사 후 응답함
- 10.1.3 쿠키란?
    - 사용자가 어떤 웹 사이트를 방문했을 때 웹 사이트가 사용하는 서버에서 사용자의 로컬 환경에 저장하는 작은 데이터
    - 이전에 방문한 적이 있는지, 이전에 로그인 했다면 로그인 정보 유지 가능
    - 키와 값으로 이루어짐
    - 만료 기간, 도메인 등의 정보를 가짐
    - HTTP 요청을 통해 쿠키의 특정 키에 값을 추가할 수 있음
    - 쿠키 추가되는 과정
        - 클라이언트가 정보 요청 → 서버에서 정보를 값으로 넣은 쿠키 생성, 요청한 정보를 함께 돌려 보냄 → 클라이언트는 로컬(브라우저)에 쿠키 저장
    - 사이트 재방문할 때 사용자는 로컬 환경에 있는 쿠키와 함께 서버에 요청

## 10.2 토큰 발급받기

- 코드 작성으로 대체함

## 10.3 스프링 시큐리티로 OAuth2 구현하고 적용하기

- OAuth2에서 제공받은 인증 객체로 사용자 정보를 가져오는 역할 서비스 구현
- WebSecurityConfig 대신 사용할 OAuth2 설정 파일 구현
- 뷰 구성
- 10.3.1 의존성 추가하기
- 10.3.2 쿠키 관리 클래스 구현하기
    - addCookie : 요청값(이름, 값, 만료 기간)을 바탕으로 HTTP 응답에 쿠키를 추가함
    - deleteCookie : 쿠키 이름을 입력받아 쿠키를 삭제함
        - 파라미터로 넘어온 쿠키를 빈 값으로 바꾸고 만료 시간을 0으로 설정해 쿠키가 재생성 되자마자 만료 처리
    - serialize : 객체를 직렬화해 쿠키의 값으로 들어갈 값으로 변환
    - deserialize : 쿠키를 역직렬화 객체로 변환함
- 10.3.3 OAuth2 서비스 구현하기
    - 사용자 정보를 조회
        - users 테이블에 사용자 정보가 있다면
            - 리소스 서버에서 제공해주는 이름을 업데이트
        - users 테이블에 사용자 정보가 없다면
            - users 테이블에 새 사용자를 생성해 DB에 저장하는 서비스 구현
    - 부모 클래스인 DefaultOAuth2UserService에서 제공하는 OAuth 서비스에서 제공하는 정보를 기반으로 유저 객체를 만들어주는 loadUser() 메서드 사용하여 사용자 객체 불러옴
        - 사용자 객체 : 식별자, 이름, 이메일, 프로필 사진 링크 등 정보를 담음
    - saveOrUpdate() 메서드 : 사용자가 user 테이블에 있으면 업데이트하고 없으면 사용자를 새로 생성해서 데이터베이스에 저장
- 10.3.4 OAuth2 설정 파일 작성하기
    - [WebOAuthSecurityConfig.java](http://WebOAuthSecurityConfig.java) 파일 생성
        - filterChain() : 기존 폼 로그인, 세션 기능 비활성화
        - addFilterBefore() 헤더값 확인용 커스텀 필터 추가
        - authorizeRequests() 메서드 URL 인증 설정
            - 토큰 재발급 URL은 인증 없이 접근 가능
            - 나머지 API들은 모두 인증을 해야 접근 가능
        - oauth2Login() 메서드 이후 체인 메서드 수정
            - OAuth2에 필요한 정보를 쿠키에 저장해서 쓸 수 있도록 인증 요청과 관련된 상태를 저장할 저장소 설정 (OAuth2AuthorizationRequestBasedOnCookieRepository.java)
                - 쿠키를 사용해 OAuth의 정보를 가져오고 저장하는 로직 작성
            - 인증 성공 시 실행할 핸들러 설정
                - BCryptPasswordEncoder 삭제 → BCryptPasswordEncoder 생성자 사용해 직접 생성 → 패스워드 암호화할 수 있게 코드 수정 → findByEmail() 메서드 추가
                - 리프레시 토큰 생성, 저장, 쿠키에 저장
                    - 토큰 제공자를 사용해 리프레시 토큰 생성
                    - saveRefreshToken() 메서드 호출해 해당 리프레시 토큰을 DB에 유저 아이디와 함께 저장
                    - 클라이언트에서 액세스 토큰이 만료되면 재발급 요청하도록 addRefreshTokenToCookie() 메서드 호출
                - 액세스 토큰 생성, 패스에 액세스 토큰 추가
                - 인증 관련 설정값, 쿠키 제거
                - 리다이렉트
        - exceptionHandling() 메서드 예외 처리
            - /api로 시작하는 url인 경우 인증 실패 시 401 상태 코드 Unaauthorized를 반환함
- 10.3.5 글에 글쓴이 추가하기
    - [BlogApiController.java](http://BlogApiController.java) 파일에서 현재 인증 정보를 가져오는 principal 객체를 파라미터로 추가함
    - 인증 객체에서 유저 이름을 가져온 뒤 save() 메서드로 넘겨줌
- 10.3.6 OAuth 뷰 구성하기
    - 코드 실습으로 대체함
- 10.3.7 글 수정, 삭제, 글쓴이 확인 로직 추가하기
    - 글을 수정하거나 삭제할 때 요청 헤더에 토큰을 전달 → 사용자 자신이 작성한 글인지 검증 가능
    - 본인 글이 아닌데 수정, 삭제를 시도하는 경우 예외를 발생시키도록 코드 수정

## 10.4 OAuth2 실행 테스트하기

- 직접 따라해보는 것으로 대체

## 10.5 테스트 코드 실패 해결하고 코드 수정하기

- 인증 객체를 저장하는 시큐리티 콘텍스트에 setAuthentication() 메서드를 사용해 테스트 유저 지정
- 글을 생성하는 API에서 파라미터로 Principal 객체를 받음 → 객체에 테스트 유저가 들어가도록 모킹
- 중복 코드 제거하기 위해 글을 만드는 로직을 createDefaultArticle() 메서드로 추출