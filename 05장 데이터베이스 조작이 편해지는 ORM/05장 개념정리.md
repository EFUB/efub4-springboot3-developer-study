# 05장 데이터베이스 조작이 편해지는 ORM

## 5.1 데이터베이스란?

- 데이터베이스
    - 데이터를 매우 효율적으로 보관하고 꺼내 볼 수 있는 곳
    - 이점 : 많은 사람이 안전하게 데이터를 사용하고 관리할 수 있음
- 데이터베이스 관리자, DBMS
    - 데이터베이스를 관리하기 위한 소프트웨어
    - 동시 접근 등 요구사항을 만족하면서 효율적으로 데이터베이스를 관리하고 운영함
    - 대표적인 DBMS : MySQL, 오라클
    - 관리 특징에 따른 분류
        - 관계형 DBMS (RDBMS)
            - 가장 많이 사용함
            - 관계형 모델을 기반으로 함
            - 테이블 형태
        - 객체-관계형 DBMS
        - 도큐먼트형 DBMS
        - 비관계형 DBMS
    - H2
        - 자바로 작성되어 있는 RDBMS
        - 스프링 부트가 지원하는 인메모리형 RDBMS, 데이터를 애플리케이션 자체 내부에 저장
        - 애플리케이션을 다시 실행하면 데이터 초기화 (간편하게 사용하기 좋아 테스트 용도로 사용)
- 꼭 알아야 할 데이터베이스 용어
    - 테이블 : 데이터를 구성하기 위한 가장 기본적인 단위로 행과 열로 구성됨
    - 행(=레코드) : 테이블의 가로로 배열된 데이터의 집합으로 반드시 고유한 식별자인 기본 키를 가짐
    - 열 : 행에 저장되는 유형의 데이터, 각 요소에 대한 속성을 나타내며 무결성 보장
    - 기본키 : 행을 구분할 수 있는 식별자로 테이블에서 유일해야 하며 중복 값을 가질 수 없음
        - 데이터를 수정, 삭제, 조회할 때 사용하며 다른 테이블과 관계를 맺어 데이터를 가져올 수도 있음
        - 기본키는 수정되면 안 되며 NULL이 될 수 없음
    - 쿼리
        - 데이터베이스에서 데이터를 조회, 삭제, 생성, 수정 같은 처리를 하기 위해 사용하는 명령문
        - SQL을 사용하여 작성

## 5.2 ORM이란?

- ORM (Object-relational mapping)
    - 자바의 객체와 데이터베이스를 연결하는 프로그래밍 기법
    - SQL을 몰라도 자바 언어로만 데이터베이스에 접근해 원하는 데이터 받아오기 가능
    - 데이터베이스 값을 마치 객체처럼 사용할 수 있음
    - 장점
        - SQL 직접 작성하지 않고 사용하는 언어로 데이터베이스에 접근할 수 있음
        - 객체지향적 코드 작성 가능 → 비즈니스 로직에만 집중 가능
        - 데이터베이스 시스템이 추상화되어 있기 때문에 다른 시스템으로 전환해도 추가 작업 거의 없음
        - 매핑하는 정보 명확 → ERD에 대한 의존도 낮추고 유지보수에 유리
    - 단점
        - 프로젝트 복잡성이 커질수록 사용 난이도도 올라감
        - 복잡하고 무거운 쿼리는 ORM으로 해결 불가능한 경우 존재

## 5.3 JPA와 하이버네이트?

- JPA
    - 자바에서는 JPA(Java Persistence API)를 표준으로 사용
    - 자바에서 관계형 데이터베이스를 사용하는 방식을 정의한 인터페이스
    - 실제 사용을 위해서는 ORM 프레임워크를 추가로 선택해야 함
- 하이버네이트
    - JPA 인터페이스를 구현한 구현체이자 자바용 ORM 프레임워크
    - 내부적으로는 JDBC API를 사용
    - 목표 : 자바 객체를 통해 데이터베이스 종류에 상관없이 데이터베이스를 자유자재로 사용할 수 있게 함
- 5.3.1 엔티티 매니저란?
    - 엔티티
        - 데이터베이스의 테이블과 매핑되는 객체
        - 객체이긴 하지만 데이터베이스에 영향을 미치는 쿼리를 실행하는 객체
    - 엔티티 매니저
        - 엔티티를 관리해 데이터베이스와 어플리케이션 사이에서 객체를 생성, 수정, 삭제하는 역할
        - 엔티티 매니저 팩토리 : 엔티티 매니저를 만드는 곳
        - 예) 회원 2명이 동시에 가입하려고 할 때?
            - 엔티티 매니저 팩토리에서 회원 1 요청에 대해 가입 처리를 할 엔티티 매니저 생성 → 가입 처리 후 데이터베이스에 회원 정보 저장
            - 회원 2도 마찬가지의 과정을 거침
            - 회원 1,2를 위해 생성된 엔티티 메니저는 필요 시점에 데이터베이스와 연결 후 쿼리함
    - 스프링 부트
        - 엔티티 매니저 팩토리를 하나만 생성, 관리
        - @PersistenceContext 또는 @Autowired을 사용해 엔티티 매니저 사용
        - 기본적으로 빈을 하나만 생성해서 공유 → 동시성 문제 → 실제로는 프록시(가짜) 엔티티 매니저를 사용
- 5.3.2 ⭐️영속성 컨텍스트란?
    - JPA의 중요한 특징 중 하나로, 엔티티를 관리하는 가상의 공간
    - 엔티티 매니저는 엔티티를 영속성 컨텍스트에 저장함
    - 특징
        - 1차 캐시
            - 내부에 1차 캐시를 가짐
            - 캐시 키 : 엔티티의 @Id가 달린 기본키 역할을 하는 식별자로 값은 엔티티
            - 엔티티 조회 : 1차 캐시에서 데이터 조회 → 값이 있으면 반환 / 값이 없으면 데이터베이스에서 조회해 1차 캐시에 저장 후 반환
            - 빠른 속도로 데이터 조회 가능
        - 쓰기 지연
            - 트랜잭션을 커밋하기 전까지 쿼리를 모았다가 트랜잭션을 커밋하면 모았던 쿼리를 한번에 실행
            - 적당한 묶음으로 쿼리를 요청하여 데이터베이스 시스템의 부담 줄임
        - 변경 감지
            - 커밋 시 1차 캐시에 저장된 엔티티 값과 현재 엔티티 값 비교 → 변경된 값이 있으면 이를 감지해 데이터베이스에 자동으로 변경된 값 반영
        - 지연 로딩
            - 쿼리로 요청한 데이터를 애플리케이션에 바로 로딩 X, 필요할 때 쿼리를 날려 데이터 조회
- 5.3.3 엔티티의 상태
    - 분리 상태 : 영속성 컨텍스트가 관리하고 있지 않음
    - 관리 상태 : 영속성 컨텍스트가 관리함
    - 비영속 상태 : 영속성 컨텍스트와 전혀 관계 없음
    - 삭제된 상태 : 영속성 컨텍스트와 데이터베이스에서 엔티티 삭제
    - 상태는 특정 메서드를 호출해 변경 가능
    
    ```java
    public class EntityManagerTest {
    
    	@Autowired
    	EntityManager em;
    	
    	public void example() {
    			//엔티티 매니저가 엔티티를 관리하지 않는 상태(비영속 상태)
    			Member member = new Member(1L, "홍길동");
    			
    			//엔티티가 관리 상태가 됩니다.(관리 상태)
    			em.persist(member);
    			//엔티티 객체가 분리된 상태가 됩니다. (분리 상태)
    			em.detach(member);
    			//엔티티 객체가 삭제된 상태가 됩니다. (삭제 상태)
    			em.remove(member);
    }
    ```
    

## 5.4 스프링 데이터와 스프링 데이터 JPA

- 스프링 데이터
    - 데이터베이스 사용 기능을 클래스 레벨에서 추상화
    - 인터페이스에서 CRUD를 포함한 여러 메서드가 포함되어 있으며 알아서 쿼리를 만들어줌
        - 장점
            - 페이징 처리 기능, 메서드 이름 자동 쿼리 빌딩 기능 제공
- 5.4.1 스프링 데이터 JPA란?
    - 스프링 데이터의 공통적인 기능에서 JPA의 유용한 기술이 추가된 기술
    - 스프링 데이터 인터페이스인 PagingAndSortingRepository를 상속받아 JpaRepository 인터페이스를 만듦
    - JpaRepository 인터페이스를 우리가 만든 인터페이스에서 상속받고 제네릭에는 관리할 **<엔티티 이름, 엔티티의 기본키 타입>**을 입력하면 기본 CRUD를 위해 만든 메서드 사용 가능
        
        ```java
        public interface MemberRepository extends JpaRepository<Member, Long>{
        }
        ```
        
- 5.4.2 스프링 데이터 JPA에서 제공하는 메서드 사용해보기

## 5.5 예제 코드 살펴보기

- @Entity : Member 객체를 JPA가 관리하는 엔티티로 지정 (Member 클래스와 실제 데이터베이스 테이블 매핑)
- @NoArgsConstructuer(access = AccessLevel.PROTECTED)
    - 엔티티는 반드시 기본 생성자가 있어야 하고 접근 제어자는 public 또는 protected여야 함
- @GeneratedValue : 기본키의 생성 방식 결정 (자동으로 기본키 증가하도록 지정 등)
    - 자동키 생성 설정 방식
        - AUTO, IDENTITY, SEQUENCE, TABLE
- @Column : 데이터베이스의 컬럼과 필드를 매핑
    - name : 필드와 매핑할 컬럼 이름
    - nullable : 컬럼의 Null 허용 여부, 설정하지 않으면 true
    - unique : 컬럼의 유일한 값 여부, 설정하지 않으면 false
    - columnDefinition : 컬럼 정보 설정. default 값을 줄 수 있음
- 리포지토리
    - 엔티티에 있는 데이터들을 조회, 저장, 변경, 삭제할 때 사용하는 인터페이스
    - JpaRepository 클래스를 상속받아 간단하게 구현 가능