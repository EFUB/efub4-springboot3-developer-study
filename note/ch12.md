# CI/CD 도입하기

## 12.1 사전 지식: CI/CD

### 12.1.1 CI/CD란?
 코드 수정을 하고, 로컬 환경에서 테스트를 진행 > 빌드도 잘되는지 확인 > jar 파일을 생성해 복사 > AWS에 접속해서 복사한 jar 파일을 업로드해 새 배포 버전을 제공

지금 이 과정을 기계적으로 계속할 수 있을까요? 프로젝트 규모가 엄청나게 커지면 이 작업은 굉장히 힘들 겁니다. 그럴 때 도입하는 것이 CI/CD ! 이 용어는 어떤 도구를 의미하는 것이 아니라 방법을 말합니다. 

이 방법을 도입하면 빌드부터 배포까지의 과정의 자동화할 수 있고, 또 잘되는지 모니터링할 수 있습니다.

**1. CI**
- Continuous Integration : 지속적 통합
- 개발자를 위해 빌드와 테스트를 자동화하는 과정
- 변경사항을 자동으로 테스트해 애플리케이션에 문제가 없다는 것을 보장
- 코드를 정기적으로 빌드하고, 테스트하므로 여러 명이 동시에 작업을 하는 경우 충돌을 방지하고 모니터링할 수 있음

**2. CD**
- CI 작업을 끝낸 다음 실행하는 작업
- 배포 준비가 된 코드를 자동으로 서버에 배포하는 작업을 자동화하는 것
- CI가 통과되면 개발자가 수작업으로 코드를 배포하지 않아도 자동으로 재포하니 매우 편리
- Continuous Delivery : 지속적 제공
   - 애플리케이션에 적용한 코드와 테스트를 성공적으로 진행했을 때 깃허브와 같은 코드 저장소에 자동으로 업로드하는 과정
- Continuous Deployment : 지속적 배포
   - 지속적 제공을 통해 성공적으로 병합한 코드 내역을 AWS와 같은 배포 환경으로 보내는 것
   - 실무에서는 이 과정을 `릴리스`라고 함



### 12.1.2 깃과 깃허브

**깃허브와 깃 연동하기**
   1. 깃허브에 가입한 사용자 이름과 이메일 주소 설정
      ```
      $ git config —global user.name “[깃허브 아이디]”
      $ git config —global user.email “[깃허브 이메일 주소]”
      ```
    
   2. 깃 SSH로 접속하기 위해 인증 정보를 등록 : SSH 키를 생성
      ```
      $ ssh-keygen –t rsa –C “[깃허브 이메일 주소]”
      ```
   3. /.ssh/id_rsa에 pub 파일 복사
   4. 깃허브 홈페이지 > [Settings] > [SSH and GPG keys] > [New SSH key]
   5. 복사해두었던 SSH 키 붙여넣기하고 [Add SSH key]를 눌러 SSH 키 추가

## 12.2 깃허브 액션 사용하기

**깃허브 액션(github actions)**
   - 리포지토리(코드 원격 저장소)에 특정 이벤트가 발생하면 특정 작업을 하거나, 주기적으로 특정 작업을 반복할 수 있도록 지원
   - 코드를 작성해 깃허브에 업데이트하면 해당 코드에 문제가 없는지 자동으로 코드를 빌드, 테스트한 이후 배포

### 12.2.1 깃허브 리포지터리 생성하고 코드 푸시하기

1. 리포지터리 생성
2. 리포지터리 SSH 주소 복사
3. 인텔리제이 프로젝트 [Termina] > git init 입력
   - git init : 특정 폴더를 깃 저장소로 만들 때 사용하는 명령어
4. 깃허브의 리포지터리와 로컬의 깃 저장소를 연결
   ```
   $ git remote add origin git@github.com:${사용자계정명}/springboot-developer.git
   ```
5. 로컬 저장소의 이력, 파일을 리포지토리에 푸시하기 위한 add, commit
6. 원격 저장소에 push



### 12.2.2 깃허브 액션 스크립트 작성하기, CI
**깃허브 액션 스크립트를 작성해 CI를 구현**
- 프로젝트 최상단에 .github 디렉터리 생성 > workflows 디렉터리 > ci.yml 파일
   - 워크플로의 이름 지정 : 해당 워크플로는 CI를 실행하기 위한 스크립트 모음
   - 워크플로를 시작할 트리거 조건 지정 : main 브랜치에 푸시할 때마다 워크플로 시작
   - 실행 환경 지정
   - 실행 스텝 그룹화 : 각 항목은 별도의 작업(uses) 또는 명령어(run)으로 이루어짐

**실행 스텝 그룹화 정리**
- uses: 지정한 리포지토리를 확인하고 코드에 대한 작업을 실행 가능
   - action/checkout에는 checkout이라는 작업의 v3 버전을 실행
- name: 스텝의 이름을 지정
- run: 실행할 명령어를 입력
   - ./gradlew clean build에는 그레들을 사용해 프로젝트를 빌드 이전 상태로 돌리고 다시 빌드하는 명령어를 실행



### 12.2.3 깃허브 액션 스크립트 작성하기, CD
1. plain.jar 생기지 않도록 gradle 파일 수정
   - plain.jar = 플레인 아카이브(plain archive): 어플리케이션 실행에 필요한 의존성을 포함하지 않고 소스 코드의 클래스 파일과 리소스 파일만 포함 -> 플레인 아카이브만으로는 서비스 실행 불가

   ```
   jar {
      enabled = false
   }
   ```
2. ci.yml -> cicd.yml 로 변경 후 코드 수정
   - josStorer/get-current-time 플러그인으로 현재 시간 가져옴 : 배포 버전 지정할 때 사용
   - 빌드 이후 생성된 jar 파일을 찾아 “artifact”라는 환경 변수에 값을 넣음 : $GITHUB_ENV를 사용해 깃허브 워크플로 전체적으로 사용할 수 있는 환경 변수 설정
   - einaregilsson/beanstalk-deploy 플러그인으로 빈스토크 배포 진행
3. 사용자 생성
   - IAM: AWS 리소스를 사용하도록 권한을 부여하는 서비스
   - AWS > IAM > [사용자] > [사용자 추가]
   - 권한 설정: [직접 정책 연결] > AdministratorAccess-AWSElasticBeanstalk 검색, 선택
     - AdministratorAccess : 빈스토크를 사용하기 위해 필요한 모든 관리 권한을 사용자에게 제공하는 권한
4. 사용자를 눌러 액세스 키 생성
5. 깃허브 리포지토리 > [Settings -> Secrets and variables -> Actions] -> [New repository secrets] 비밀키를 등록