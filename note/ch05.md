# 데이터베이스 조작이 편해지는 ORM

## 데이터베이스란?

**데이터베이스 관리자, DBMS**
- DBMS : 데이터베이스를 관리하기 위한 소프트웨어
   - MySQL, 오라클도 DBMS.
   - 관리 특징에 따라 관계형, 객체-관계형, 도큐먼트형, 비관계형 등으로 분류
<br/>

**관계형 DBMS** 
- RDBMS : relational DBMS
- 테이블 형태로 이루어진 데이터 저장소
<br/>

- H2, MySQL
   - H2 : 자바로 작성되어 있는 RDBMS, 스프링 부트가 지원하는 인메모리 관계형 데이터베이스.
      - 애플리케이션 자체에 데이터 저장 -> 애플리케이션 다시 실행하면 데이터 초기화
      - 주로 테스트 용도로 사용
   - MySQL : 실제 서비스로 올릴 때 사용

**꼭 알아야 할 데이터베이스 용어** 
- `테이블 (table)`
   - 데이터베이스에서 데이터를 구성하기 위한 가장 기본적 단위
   - 행과 열로 구성, 행은 여러 속성으로 구성
- `행 (row)`
   - 테이블의 구성요소로 테이블의 가로로 배열된 데이터의 집합
   - 고유한 식별자인 기본키를 가짐
   - 레코드(record)라고도 함
- `열 (column)`
   - 테이블의 구성요소로 행에 저장되는 유형의 데이터
   - 각 요소에 대한 속성을 나타내며 무결성 보장
- `기본키 (primary key)`
   - 행을 구분할 수 있는 식별자
   - 테이블에서 유일하고 중복값 가질 수 없음, 수정 불가능, NULL이 아닌 유효한 값이어야 함
   - 데이터 수정,삭제,조회에서 사용
- `쿼리 (query)`
   - 데이터베이스에서 데이터 조회,삭제,생성,수정 같은 처리를 하기 위한 명령문
   - SQL이라는 데이터베이스 전용 언어 사용
---

## ORM이란?

- 자바의 객체와 데이터베이스를 연결하는 프로그래밍 기법
   - 데이터베이스의 값을 객체처럼 사용할 수 있게 하여 자바 언어로만 데이터베이스를 다룰 수 있게 하는 도구
---

## JPA와 하이버네이트

- JPA (Java Persistence API)
   - 자바에서 관계형 데이터베이스를 사용하는 방식을 정의한 인터페이스
   - 자바 객체와 데이터베이스를 연결해 데이터 관리
- 하이버네이트
   - JPA 인터페이스를 구현한 구현체이자 자바용 ORM 프레임워크
<br/>

- JPA의 중요한 컨셉 : 엔티티 매니저 & 영속성 컨텍스트
**엔티티 메니저**
- 엔티티 (entity)
   - 데이터베이스의 테이블과 매핑되어 쿼리를 실행하는 객체
   - 자바의 일반 객체와 다르지 않지만 데이터베이스 테이블과 직접 연결된다는 특별한 특징이 있어 구분지어 부름
- 엔티티 매니저 (entity manager)
   - 엔티티를 관리해 데이터베이스와 애플리케이션 사이에서 객체를 생성, 수정, 삭제하는 역할
   - 엔티티 매니저 팩토리에서 엔티티 매니저 생성
   - ex) 회원 1이 회원 가입을 하려는 경우, 엔티티 매니저 팩토리가 회원 1의 요청에 대한 가입 처리를 할 엔티티 매니저를 생성하고 이를 통해 가입 처리하여 데이터베이스에 회원 정보 저장

**영속성 컨텍스트**
- 엔티티를 관리하는 가상의 공간
- 엔티티 매니저는 엔티티를 영속성 컨텍스트에 저장
- 특징
   - `1차 캐시`
      - 캐시된 데이터를 빠르게 조회 가능
      - 엔티티 조회하면 1차 캐시에서 데이터 조회하고 값을 반환
      - 1차 캐시에 값이 없으면 데이터베이스에서 조회하여 1차 캐시에 저장 후 반환
   - `쓰기 지연`
      - 트랜잭션을 커밋할 때 모아놨던 쿼리를 한번에 실행하는 것
   - `변경 감지`
      - 트랜잭션을 커밋하면 1차 캐시에 저장되어 있는 엔티티의 값을 현재 엔티티의 값과 비교해서 변경사항을 감지하여 데이터베이스에 반영
   - `지연 로딩`
      - 필요할 때 쿼리를 날려 데이터를 조회

**엔티티의 상태**
- 분리 상태 : 영속성 컨텍스트가 관리하고 있지 않은 상태
   - detach() 메서드를 이용해 분리 상태로 변경 가능
- 관리 상태 : 영속성 컨텍스트가 관리하고 있는 상태
   - persist() 메서드로 엔티티를 관리 상태로 변경 가능
- 비영속 상태 : 영속성 컨텍스트와 전혀 관계 없는 상태
   - 엔티티 처음 생성하면 엔티티 매니저가 엔티티를 관리하지 않는 비영속 상태가 됨
- 삭제된 상태
    - 더 이상 객체가 필요 없다면 remove() 메서드로 삭제 가능
---

## 스프링 데이터와 스프링 데이터 JPA

- 스프링 데이터 : 데이터베이스 사용 기능을 클래스 레벨에서 추상화한 것
   - 스프링 데이터에서 제공하는 인터페이스를 통해 스프링 데이터 사용 가능
   - 각 데이터베이스 특성에 맞춰 기능을 확장하여 제공하는 기술 제공

**스프링 데이터 JPA**
- 스프링 데이터의 공통적인 기능에서 JPA의 유용한 기술이 추가된 기술
- 스프링 데이터의 인터페이스인 PagingAndSortingRepository를 상속받은 JpaRepository 인터페이스로 JPA를 편리하게 사용하는 메서드 제공
```java
// JpaRepository 인터페이스를 상속받는 인터페이스를 만들면 CRUD 메서드 사용 가능
// <엔티티 이름, 엔티티 기본키의 타입> 입력
public interface MemberRepository extends JpaRepository<Member, Long>{
}
```
1. 생성 (create)
   - save() 메서드로 데이터 객체 저장
   ```java
   memberRepository.save(new Member(1L, “A”));
   ```
2. 조회 (read)
   - findById() 메서드에 id를 지정해 엔티티 하나 조회
   - findAll() 메서드로 전체 엔티티 조회
   ```java
   Optional<Member> member = memberRepository.findById(1L);  // 단건조회   
   List<Member> allMembers = memberRepository.findAll();    // 전체조회
   ```
3. 삭제 (delete)
   - deleteById() 메서드에 id 지정해 엔티티 삭제
   ```java
   memberRepository.deleteById(1L);
   ```
---

## 예제 코드 살펴보기 

- Member.java
    - `@Entity` : Member 객체를 JPA가 관리하는 엔티티로 지정하는 애너테이션
        - member 클래스와 데이터베이스의 테이블을 매핑
   ```java
   @Entity // 클래스이름과 같은 이름의 테이블과 매핑    
   public class Member {
    }
   ```
   ```java
   @Entity(name = “member_list”) // @Entity의 name속성을 사용하여 “member_list”라는 이름의 테이블과 매핑 
   public class Article {
    }
   ```
    - `@NoArgsConstructor(access = AccessLevel.PROTECTED)` : protected 기본 생성자
        - 엔티티는 반드시 public 혹은 protected 기본 생성자 있어야 함
    - `@Id` : Long 타입의 id 필드를 데이블의 기본키로 지정
    - `@GeneratedValue` : 기본키의 생성방식 결정하는 애너테이션
        - 자동키 생성 설정 방식
            - AUTO : 선택한 데이터베이스 방언에 따라 방식을 자동으로 선택(기본값)
            - IDENTITY : 기본키 생성을 데이터베이스에 위임(=AUTO_INCREMENT)
            - SEQUENCE : 데이터 베이스 시퀀스를 사용하여 기본키 할당 (오라클)
            - TABLE : 키 생성 테이블 사용
    - `@Column` : 데이터베이스의 칼럽과 필드를 매핑
        - @Column 애너테이션 속성
            - name : 필드와 매핑할 칼럼. 설정하지 않으면 필드 이름으로 지정
            - nullable : 컴럼 null 허용 여부. 설정하지 않으면 true(nullable)
            - unique : 컬럼의 유일한 값 여부. 설정하지 않으면 false(non-unique)
            - columnDefinition : 컬럼 정보 설정